{{#if ts}}
import cache from "@/services/cache.service";
import mailService from "@/services/mail.service";
import { hashOTP } from "@/common/utils/cryptographer";
import ApiError from "@/common/utils/ApiError";
{{else}}
import cache from "../../../services/cache.service";
import mailService from "../../../services/mail.service";
import { hashOTP } from "../../../common/utils/cryptographer";
import ApiError from "../../../common/utils/ApiError";
{{/if}}

class OtpService {
  async sendOtp(email{{#if ts}}: string{{/if}}) {
    const data = await mailService.send(
      email,
      "OTP",
      {},
      { from: `"." <no-reply@..com>` }
    );

    if (!data?.success || !data?.details?.otp)
      throw new ApiError({ statusCode: 500, message: "OTP send failed" });

    const hashed = await hashOTP(data.details.otp as string);
    cache.set(`otp:${email}`, hashed, 65);

    return { otp: data.details.otp, messageId: data.messageId };
  }

  async verifyOtp({{#if ts}}email: string, otp: string{{else}}email, otp{{/if}}) {
    const cached = cache.get{{#if ts}}<string>{{/if}}(`otp:${email}`);
    if (!cached) return false;

    const hashed = await hashOTP(otp);
    if (hashed !== cached) return false;

    cache.del(`otp:${email}`);
    return true;
  }
}

export default new OtpService();
