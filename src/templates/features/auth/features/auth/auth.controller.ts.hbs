import { Request, Response } from "express";
{{#if ts}}
import { ApiError } from "@/common/utils/ApiError";
import authService from "@/features/auth/auth.service";
import asyncHandler from "@/common/utils/asyncHandler";
import ApiResponse from "@/common/utils/ApiResponse";
{{else}}
import authService from "./auth.service";
import { ApiError } from "../../common/utils/ApiError";
import asyncHandler from "../../common/utils/asyncHandler";
import ApiResponse from "../../common/utils/ApiResponse";
{{/if}}

export const googleCallback = asyncHandler(
  async ({{#if ts}}req: Request, res: Response{{else}}req, res{{/if}}) => {
    const code = req.query.code as string;

    const { redirectUrl } = await authService.handleGoogleOAuth(code, req);

    return res.redirect(redirectUrl);
  }
);

export const handleUserOAuth = asyncHandler(
  async ({{#if ts}}req: Request, res: Response{{else}}req, res{{/if}}) => {
    const { email, username } = req.body;

    const { createdUser, accessToken, refreshToken } =
      await authService.handleUserOAuth(email, username, req);

    authService.setAuthCookies(res, accessToken, refreshToken);
    return ApiResponse.created(
      {
        ...createdUser,
        refreshToken: null,
        password: null,
        email: null,
      },
      "Form submitted successfully!"
    );
  }
);

export const handleTempToken = asyncHandler(
  async ({{#if ts}}req: Request, res: Response{{else}}req, res{{/if}}) => {
    const { tempToken } = req.body;

    const tokens = authService.redeemTempToken(tempToken);

    if (!tokens)
      throw new ApiError({
        statusCode: 400,
        message: "Invalid or expired token",
        code: "INVALID_TEMP_TOKEN",
        data: { service: "authService.handleTempToken" },
      });

    const { accessToken, refreshToken } = tokens;

    authService.setAuthCookies(res, accessToken, refreshToken);
    return ApiResponse.ok({
      success: true,
    });
  }
);

export const initializeUser = asyncHandler(
  async ({{#if ts}}req: Request, res: Response{{else}}req, res{{/if}}) => {
    const { email, username, password } = req.body;

    // Optional: can replace this with a Zod validation middleware
    if (!email || !username || !password)
      throw new ApiError({
        statusCode: 400,
        message: "All fields are required",
        data: { service: "authService.initializeAuthService" },
      });

    const savedEmail = await authService.initializeAuthService(
      email,
      username,
      password
    );

    return ApiResponse.created(
      {
        email: savedEmail,
      },
      "User initialized successfully and OTP sent"
    );
  }
);

export const registerUser = asyncHandler(
  async ({{#if ts}}req: Request, res: Response{{else}}req, res{{/if}}) => {
    const { email } = req.body;

    const { createdUser, accessToken, refreshToken } =
      await authService.registerAuthService(email, req);

    authService.setAuthCookies(res, accessToken, refreshToken);
    return ApiResponse.created(
      {
        ...createdUser,
        refreshToken: null,
        password: null,
        email: null,
      },
      "Form submitted successfully!"
    );
  }
);

export const loginUser = asyncHandler(async ({{#if ts}}req: Request, res: Response{{else}}req, res{{/if}}) => {
  const { email, password } = req.body;

  const { user, accessToken, refreshToken } =
    await authService.loginAuthService(email, password, req);

  authService.setAuthCookies(res, accessToken, refreshToken);

  return ApiResponse.ok(
    {
      ...user,
      password: null,
      refreshToken: null,
    },
    "User logged in successfully!"
  );
});

export const getUserData = asyncHandler(async ({{#if ts}}req: Request, res: Response{{else}}req, res{{/if}}) => {
  if (!req.body.user || !req.body.user.id) {
    throw new ApiError({
      statusCode: 400,
      message: "User not found",
      data: { service: "authService.getUserDataService" },
    });
  }

  const user = {
    ...req.body.user,
    password: null,
    refreshToken: null,
  };

  return ApiResponse.ok(user, "User fetched successfully!");
});

export const getUserById = asyncHandler(async ({{#if ts}}req: Request, res: Response{{else}}req, res{{/if}}) => {
  const { userId } = req.params;

  const user = await authService.getUserByIdService(userId);

  return ApiResponse.ok(user, "User feteched successfully");
});

export const logoutUser = asyncHandler(async ({{#if ts}}req: Request, res: Response{{else}}req, res{{/if}}) => {
  if (!req.body.user?.id)
    throw new ApiError({
      statusCode: 400,
      message: "User not found",
      data: { service: "authService.logoutAuthService" },
    });

  await authService.logoutAuthService(req.body.user.id);

  authService.clearAuthCookies(res);

  return ApiResponse.ok({ success: true }, "User logged out successfully");
});

export const refreshAccessToken = asyncHandler(
  async ({{#if ts}}req: Request, res: Response{{else}}req, res{{/if}}) => {
    const incomingRefreshToken =
      req.cookies.refreshToken || req.body.refreshToken;

    if (!incomingRefreshToken)
      throw new ApiError({
        statusCode: 401,
        message: "Unauthorized request",
        data: { service: "authService.refreshAccessTokenService" },
      });

    const { accessToken, refreshToken } =
      await authService.refreshAccessTokenService(incomingRefreshToken, req);

    authService.setAuthCookies(res, accessToken, refreshToken);

    return ApiResponse.ok(
      { success: true },
      "Access token refreshed successfully"
    );
  }
);

export const sendOtp = asyncHandler(async ({{#if ts}}req: Request, res: Response{{else}}req, res{{/if}}) => {
  const { email } = req.body;

  const { messageId } = await authService.sendOtpService(email);

  return ApiResponse.ok(
    {
      messageId,
    },
    "OTP sent successfully"
  );
});

export const verifyOtp = asyncHandler(async ({{#if ts}}req: Request, res: Response{{else}}req, res{{/if}}) => {
  const { email, otp } = req.body;

  const isVerified = await authService.verifyOtpService(email, otp);

  return ApiResponse.ok(
    {
      isVerified,
    },
    isVerified ? "OTP verified successfully" : "Invalid OTP"
  );
});

export const searchUsers = asyncHandler(async ({{#if ts}}req: Request, res: Response{{else}}req, res{{/if}}) => {
  const { query } = req.params;

  const users = await authService.searchUsersService(query);

  return ApiResponse.ok(users, "Users fetched successfully");
});
