import jwt from "jsonwebtoken";
import { Request } from "express";
import { env } from "@/common/config/env";
import { randomUUID } from "node:crypto";
{{#if ts}}import * as authRepo from "@/features/auth/core/auth.repository";
{{#if useDrizzle}}import db from "@/common/config/db";
import { DB } from "@/common/config/db/types";{{/if}}{{else}}
import * as authRepo from "../core/auth.repository.js";
{{#if useDrizzle}}import db from "../../common/config/db/index.js";
import { DB } from "../../common/config/db/types.js";{{/if}}{{/if}}

class TokenService {
  accessTokenExpiryMs = 1000 * 60 * parseInt(env.ACCESS_TOKEN_TTL || "0", 10);
  refreshTokenExpiryMs =
    1000 * 60 * 60 * 24 * parseInt(env.REFRESH_TOKEN_TTL || "0", 10);

  generateAccessToken({{#if ts}}id: string, username: string{{else}}id, username{{/if}}) {
    return jwt.sign({ id, username }, env.ACCESS_TOKEN_SECRET, {
      expiresIn: `${env.ACCESS_TOKEN_TTL}m` as jwt.SignOptions["expiresIn"],
    });
  }

  generateRefreshToken({{#if ts}}id: string, username: string{{else}}id, username{{/if}}) {
    return jwt.sign({ id, username }, env.REFRESH_TOKEN_SECRET, {
      expiresIn: `${env.REFRESH_TOKEN_TTL}d` as jwt.SignOptions["expiresIn"],
    });
  }

  async generateAndPersistTokens(
    {{#if ts}}id: string,
    username: string,
    _req: Request,
    dbTx?: {{#if usePrisma}}Prisma.TransactionClient{{/if}}{{#if useDrizzle}}DB{{/if}}{{#if useMongodb}}ClientSession{{/if}}{{#if useSequelize}}Transaction{{/if}}{{else}}id, username, _req, dbTx{{/if}}
  ) {
    const client = dbTx ?? db;
    return await client.transaction(async (tx) => {
      const accessToken = this.generateAccessToken(id, username);
      const refreshToken = this.generateRefreshToken(id, username);

      await authRepo.updateRefreshToken(id, refreshToken, tx);

      return { accessToken, refreshToken };
    });
  }

  createTempTokenPair({{#if ts}}accessToken: string, refreshToken: string{{else}}accessToken, refreshToken{{/if}}) {
    const tempToken = randomUUID();
    return {
      tempToken,
      payload: { accessToken, refreshToken, createdAt: Date.now() },
    };
  }
}

export default new TokenService();
