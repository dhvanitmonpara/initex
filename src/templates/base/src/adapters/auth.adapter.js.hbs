{{#if ts}}
import { IUser } from "@/common/types/IUser";
{{#if usePrisma}}
import prisma, { Prisma } from "@/common/config/db";
{{/if}}
{{#if useDrizzle}}
import { eq, or, sql } from "drizzle-orm";
import db from "@/common/config/db/index";
import { UserTable } from "@/features/user/user.table";
{{/if}}
{{#if useMongodb}}
import { toObjectId } from "@/common/utils/toObject";
import UserModel from "@/features/user/user.model";
import { Types, ClientSession } from "mongoose";
{{/if}}
{{#if useSequelize}}
import User from "@/features/auth/auth.model";
import { Op, Transaction } from "sequelize";
{{/if}}
{{else}}
import { IUser } from "../common/types/IUser.js";
{{#if usePrisma}}
import prisma from "../common/db/index.js";
{{/if}}
{{#if useDrizzle}}
import { eq, or, sql } from "drizzle-orm";
import db from "../common/db/index.js";
import { UserTable } from "../common/db/schema.js";
{{/if}}
{{#if useMongodb}}
import { toObjectId } from "../common/utils/toObject.js";
import UserModel from "../features/user/user.model.js";
{{/if}}
{{#if useSequelize}}
import User from "../features/auth/auth.model";
import { Op } from "sequelize";
{{/if}}
{{/if}}

export const findById = async (
  {{#if ts}}userId: string{{else}}userId{{/if}}, 
  {{#if ts}}dbTx?: {{#if usePrisma}}Prisma.TransactionClient |{{/if}}{{#if useDrizzle}}typeof db |{{/if}}{{#if useMongodb}}ClientSession |{{/if}}{{#if useSequelize}}Transaction |{{/if}}undefined{{else}}dbTx{{/if}}
) => {
  {{#if usePrisma}}
  const client = dbTx ?? prisma;
  const user = await client.user.findUnique({ where: { id: userId } });
  {{/if}}
  {{#if useMongodb}}
  const session = dbTx ?? null;
  const user = await UserModel.findById(toObjectId(userId)).session(session);
  {{/if}}
  {{#if useDrizzle}}
  const client = dbTx ?? db;
  const user = await client.query.users.findFirst({
    where: eq(UserTable.id, userId),
  });
  {{/if}}
  {{#if useSequelize}}
  const record = await User.findOne({
    where: { id: userId },
    transaction: dbTx ?? undefined,
  });
  const user = record?.dataValues ?? null;
  {{/if}}

  return user;
};

export const updateRefreshToken = async (
  {{#if ts}}id: string, 
  refreshToken: string{{else}}user, 
  refreshToken{{/if}}, 
  {{#if ts}}dbTx?: {{#if usePrisma}}Prisma.TransactionClient |{{/if}}{{#if useDrizzle}}typeof db |{{/if}}{{#if useMongodb}}ClientSession |{{/if}}{{#if useSequelize}}Transaction |{{/if}} undefined{{else}}dbTx{{/if}}
) => {
  {{#if usePrisma}}
  const client = dbTx ?? prisma;
  await client.user.update({
    where: { id },
    data: { refreshToken },
  });
  {{/if}}
  {{#if useMongodb}}
  const session = dbTx ?? null;
  await UserModel.findByIdAndUpdate(
    toObjectId(id),
    { $set: { refreshToken } },
    { new: true, runValidators: true, session }
  );
  {{/if}}
  {{#if useDrizzle}}
  const client = dbTx ?? db;
  await client
    .update(UserTable)
    .set({ refreshToken })
    .where(eq(UserTable.id, id))
  {{/if}}
  {{#if useSequelize}}
  await User.update(
    { refreshToken },
    { where: { id }, transaction: dbTx ?? undefined }
  );
  {{/if}}
};

export const findByEmail = async (
  {{#if ts}}email: string{{else}}email{{/if}}, 
  {{#if ts}}dbTx?: {{#if usePrisma}}Prisma.TransactionClient |{{/if}}{{#if useDrizzle}}typeof db |{{/if}}{{#if useMongodb}}ClientSession |{{/if}}{{#if useSequelize}}Transaction |{{/if}} undefined{{else}}dbTx{{/if}}
) => {
  {{#if usePrisma}}
  const client = dbTx ?? prisma;
  const user = await client.user.findFirst({
    where: { email: email.toLowerCase() },
  });
  {{/if}}
  {{#if useMongodb}}
  const session = dbTx ?? null;
  const user = await UserModel.findOne({
    email: email.toLowerCase(),
  }).session(session);
  {{/if}}
  {{#if useDrizzle}}
  const client = dbTx ?? db;
  const user = await client.query.users.findFirst({
    where: eq(UserTable.email, email.toLowerCase()),
  });
  {{/if}}
  {{#if useSequelize}}
  const record = await User.findOne({
    where: { email: email.toLowerCase() },
    transaction: dbTx ?? undefined,
  });
  const user = record?.dataValues ?? null;
  {{/if}}

  return user;
};

export const create = async (
  {{#if ts}}user: IUser{{else}}user{{/if}}, 
  {{#if ts}}dbTx?: {{#if usePrisma}}Prisma.TransactionClient |{{/if}}{{#if useDrizzle}}typeof db |{{/if}}{{#if useMongodb}}ClientSession |{{/if}}{{#if useSequelize}}Transaction |{{/if}} undefined{{else}}dbTx{{/if}}
) => {
  {{#if usePrisma}}
  const client = dbTx ?? prisma;
  const createdUser = await client.user.create({ data: user });
  {{/if}}
  {{#if useMongodb}}
  const session = dbTx ?? null;
  const createdUser = await UserModel.create([user], { session }).then(r => r[0]);
  {{/if}}
  {{#if useDrizzle}}
  const client = dbTx ?? db;
  const createdUser = await client
    .insert(UserTable)
    .values(user)
    .returning()
    .then(r => r?.[0] ?? null);
  {{/if}}
  {{#if useSequelize}}
  const created = await User.create({ ...user }, { transaction: dbTx ?? undefined });
  const createdUser = created?.dataValues ?? null;
  {{/if}}

  return createdUser;
};

export const findByUsername = async (
  {{#if ts}}username: string{{else}}username{{/if}}, 
  {{#if ts}}dbTx?: {{#if usePrisma}}Prisma.TransactionClient |{{/if}}{{#if useDrizzle}}typeof db |{{/if}}{{#if useMongodb}}ClientSession |{{/if}}{{#if useSequelize}}Transaction |{{/if}} undefined{{else}}dbTx{{/if}}
) => {
  {{#if usePrisma}}
  const client = dbTx ?? prisma;
  const user = await client.user.findFirst({ where: { username } });
  {{/if}}
  {{#if useMongodb}}
  const session = dbTx ?? null;
  const user = await UserModel.findOne({ username }).session(session);
  {{/if}}
  {{#if useDrizzle}}
  const client = dbTx ?? db;
  const user = await client.query.users.findFirst({
    where: eq(UserTable.username, username),
  });
  {{/if}}
  {{#if useSequelize}}
  const record = await User.findOne({
    where: { username },
    transaction: dbTx ?? undefined,
  });
  const user = record?.dataValues ?? null;
  {{/if}}

  return user;
};

export const searchUsers = async (
  {{#if ts}}query: string{{else}}query{{/if}}, 
  {{#if ts}}dbTx?: {{#if usePrisma}}Prisma.TransactionClient |{{/if}}{{#if useDrizzle}}typeof db |{{/if}}{{#if useMongodb}}ClientSession |{{/if}}{{#if useSequelize}}Transaction |{{/if}} undefined{{else}}dbTx{{/if}}
) => {
  {{#if usePrisma}}
  const client = dbTx ?? prisma;
  const users = await client.user.findMany({
    where: {
      OR: [
        { username: { contains: query, mode: "insensitive" } },
        { email: { contains: query, mode: "insensitive" } },
      ],
    },
    select: { id: true, username: true, email: true },
  });
  {{/if}}
  {{#if useMongodb}}
  const session = dbTx ?? null;
  const users = await UserModel.find(
    {
      $or: [
        { username: { $regex: query, $options: "i" } },
        { email: { $regex: query, $options: "i" } },
      ],
    },
    { _id: 1, username: 1, email: 1 }
  ).session(session).lean();
  {{/if}}
  {{#if useDrizzle}}
  const client = dbTx ?? db;
  const users = await client.query.users.findMany({
    where: or(
      sql`LOWER(${UserTable.username}) LIKE LOWER(${`%${query}%`})`,
      sql`LOWER(${UserTable.email}) LIKE LOWER(${`%${query}%`})`
    ),
    columns: {
      id: true,
      username: true,
      email: true,
    },
  });
  {{/if}}
  {{#if useSequelize}}
  const users = await User.findAll({
    where: {
      [Op.or]: [
        { username: { {{#if useMysql}}[Op.like]{{else}}[Op.iLike]{{/if}}: `%${query}%` } },
        { email: { {{#if useMysql}}[Op.like]{{else}}[Op.iLike]{{/if}}: `%${query}%` } },
      ],
    },
    attributes: ["id", "username", "email"],
    transaction: dbTx ?? undefined,
  }).then(records => records.map(r => r.dataValues));
  {{/if}}

  return users;
};
